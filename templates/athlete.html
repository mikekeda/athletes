{% extends 'base.html' %}
{% load static from staticfiles %}
{% load i18n %}
{% load humanize %}
{% load core_tags %}

{% block title %}{{ athlete.name }}{% endblock %}

{% block content %}
    <div class="athlete-page container mt-9">
        <div class="row">
            <div class="col-sm-4 float-left">
                {{ athlete.photo_preview }}
                <div class=" mt-3">
                    <form action="{% url 'core:athletes_list' %}" id="athletes_lists_form">
                        {% csrf_token %}
                        <input type="number" name="athlete" class="d-none" value="{{ athlete.id }}">
                        <label for="athletes_lists">{% trans "Is part of lists" %}:</label>
                        <select multiple name="athletes_lists" name="athletes_lists" id="athletes_lists" class="form-control select2">
                            {% for athletes_list in athletes_lists %}
                                <option {% if athletes_list.selected %}selected{% endif %} value="{{ athletes_list.pk }}">{{ athletes_list.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
            <div class="col-sm-8 float-right">
                <h1>{{ athlete.name }}</h1>
                <p>Category: {{ athlete.category }}</p>
                <p>Gender: {{ athlete.get_gender_display }}</p>
                <p>Date of Birth (Age): {{ athlete.birthday }} ({{ athlete.age }})</p>
                <p>Place of Birth: <i class="flag flag-{{ athlete.domestic_market|lower }}"></i> {{ athlete.get_domestic_market_display }}</p>
                <p>Team: {% if athlete.team_model %}<a href="{% url 'core:team' athlete.team_model.pk %}">{{ athlete.team }}</a>{% else %}{{ athlete.team }}{% endif %}</p>
                <p>Location: <i class="flag flag-{{ athlete.location_market|lower }}"></i> {{ athlete.get_location_market_display }}</p>
                <p>Marketability: {{ athlete.marketability }}</p>
                <p>International: {{ athlete.international }}</p>
                <div>
                    {% if athlete.twitter_info %}
                        <a href="https://twitter.com/{{ athlete.twitter_info|get_item:'screen_name' }}" target="_blank"><img class="icon" src="{% static 'img/twitter.svg' %}" alt="twitter"></a>
                        <span class="badge">{{ athlete.twitter_info|get_item:'followers_count'|intcomma }}</span>
                    {% endif %}
                    {% if athlete.youtube_info %}
                        <a href="https://www.youtube.com/channel/{{ athlete.youtube_info|get_item:"channelId" }}" target="_blank"><img class="icon" src="{% static 'img/youtube.svg' %}" alt="youtube"></a>
                        <span class="badge">{{ athlete.youtube_info|get_item:'subscriberCount'|intcomma }}</span>
                    {% endif %}
                    <!--<a href="#" target="_blank"><img class="icon" src="{% static 'img/instagram.svg' %}" alt="instagram"></a>-->
                </div>
                <ul class="nav nav-tabs mt-3" id="charts" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="youtube-trends-tab" data-toggle="tab" href="#youtube-trends" role="tab" aria-controls="youtube trends" aria-selected="true">{% trans "Youtube trends" %}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="youtube-stats-tab" data-toggle="tab" href="#youtube-stats" role="tab" aria-controls="youtube stats" aria-selected="false">{% trans "Youtube stats" %}</a>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="youtube-trends" role="tabpanel" aria-labelledby="home-tab">
                        <canvas id="youtube-trends-canv" width="400" height="200"></canvas>
                    </div>
                    <div class="tab-pane fade" id="youtube-stats" role="tabpanel" aria-labelledby="profile-tab">
                        <canvas id="youtube-stats-canv" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block script %}
<script>
    let i;
    let _date;
    let trends = {{ athlete.get_youtube_weekly_stats|safe }};
    let stats = {{ athlete.get_youtube_stats|safe }};

    let stats_subscribers;
    let stats_views;
    let lineChartData;

    stats_subscribers = [];
    stats_views = [];

    for (i in trends) {
        _date = new Date(trends[i][0]);

        stats_subscribers.push({
            "x": _date,
            "y": trends[i][1][0]
        });

        stats_views.push({
            "x": _date,
            "y": trends[i][1][1]
        });
    }

    // TODO[Mike] Debug info, should be removed latter.
    console.log("stats", trends);
    console.log("stats_subscribers", stats_subscribers);
    console.log("stats_views", stats_views);

    lineChartData = {
        datasets: [{
            label: 'New Subscribers',
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgb(255, 99, 132)',
            fill: false,
            data: stats_subscribers,
            yAxisID: 'y-axis-1',
        }, {
            label: 'New views',
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgb(54, 162, 235)',
            fill: false,
            data: stats_views,
            yAxisID: 'y-axis-2'
        }]
    };

    window.onload = function() {
        let ctx_trends = document.getElementById('youtube-trends-canv').getContext('2d');
        let ctx_stats = document.getElementById('youtube-stats-canv').getContext('2d');

        window.trends = Chart.Line(ctx_trends, {
            data: lineChartData,
            options: {
                responsive: true,
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: true,
                    text: 'Youtube trends'
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            parser: 'YYYY-MM-DD',
                            tooltipFormat: 'll'
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Date'
                        }
                    }],
                    yAxes: [{
                        type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                        display: true,
                        position: 'left',
                        ticks: {
                            fontColor: 'rgb(255, 99, 132)'
                        },
                        id: 'y-axis-1',
                    }, {
                        type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                        display: true,
                        position: 'right',
                        ticks: {
                            fontColor: 'rgb(54, 162, 235)'
                        },
                        id: 'y-axis-2',

                        // grid line settings
                        gridLines: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    }],
                }
            }
        });

        stats_subscribers = [];
        stats_views = [];

        for (i in stats) {
            _date = new Date(stats[i][0]);

            stats_subscribers.push({
                "x": _date,
                "y": stats[i][1][0]
            });

            stats_views.push({
                "x": _date,
                "y": stats[i][1][1]
            });
        }

        lineChartData = {
            datasets: [{
                label: 'Subscribers',
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgb(255, 99, 132)',
                fill: false,
                data: stats_subscribers,
                yAxisID: 'y-axis-1',
            }, {
                label: 'Views',
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgb(54, 162, 235)',
                fill: false,
                data: stats_views,
                yAxisID: 'y-axis-2'
            }]
        };

        window.stats = Chart.Line(ctx_stats, {
            data: lineChartData,
            options: {
                responsive: true,
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: true,
                    text: 'Youtube stats'
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            parser: 'YYYY-MM-DD',
                            tooltipFormat: 'll'
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Date'
                        }
                    }],
                    yAxes: [{
                        type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                        display: true,
                        position: 'left',
                        ticks: {
                            fontColor: 'rgb(255, 99, 132)'
                        },
                        id: 'y-axis-1',
                    }, {
                        type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                        display: true,
                        position: 'right',
                        ticks: {
                            fontColor: 'rgb(54, 162, 235)'
                        },
                        id: 'y-axis-2',

                        // grid line settings
                        gridLines: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    }],
                }
            }
        });
    };
</script>
{% endblock %}
